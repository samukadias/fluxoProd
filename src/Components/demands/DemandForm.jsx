import React, { useState } from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Calendar } from "@/components/ui/calendar";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { format, parseISO } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import { CalendarIcon, Save, X, Check, ChevronsUpDown } from "lucide-react";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { cn } from "@/lib/utils";

<<<<<<< HEAD
const STAGES = [
    "Triagem",
    "Qualificação",
    "PO",
    "OO",
    "RT",
    "KIT"
];

=======
>>>>>>> b0affbe18c16533c8cdd62eb233f9bbe66e897a1
const STATUS_LIST = [
    "PENDENTE TRIAGEM",
    "TRIAGEM NÃO ELEGÍVEL",
    "DESIGNADA",
    "EM QUALIFICAÇÃO",
    "EM ANDAMENTO",
    "CORREÇÃO",
    "PENDÊNCIA DDS",
    "PENDÊNCIA DOP",
    "PENDÊNCIA DOP E DDS",
    "PENDÊNCIA COMERCIAL",
    "PENDÊNCIA FORNECEDOR",
    "CONGELADA",
    "ENTREGUE",
    "CANCELADA"
];

export default function DemandForm({
    demand,
    onSave,
    onCancel,
    isLoading,
    analysts = [],
    clients = [],
    cycles = [],
    requesters = [],
    userRole = 'user',
    isNew = false
}) {
    const [formData, setFormData] = useState({
        demand_number: demand?.demand_number || '',
        product: demand?.product || '',
        artifact: demand?.artifact || 'Orçamento',
        weight: demand?.weight ?? 1,
        complexity: demand?.complexity || 'Média',
        qualification_date: demand?.qualification_date || '',
        expected_delivery_date: demand?.expected_delivery_date || '',
        delivery_date: demand?.delivery_date || '',
        delivery_date_change_reason: '',
        status: demand?.status || 'PENDENTE TRIAGEM',
        observation: demand?.observation || '',
        client_id: demand?.client_id || '',
        cycle_id: demand?.cycle_id || '',
<<<<<<< HEAD
        stage: demand?.stage || 'Triagem',
=======
>>>>>>> b0affbe18c16533c8cdd62eb233f9bbe66e897a1
        analyst_id: demand?.analyst_id || '',
        requester_id: demand?.requester_id || '',
        support_analyst_id: demand?.support_analyst_id || ''
    });

    const isGestor = ['admin', 'manager', 'general_manager'].includes(userRole);

    const originalDeliveryDate = demand?.delivery_date || '';
    const deliveryDateChanged = formData.delivery_date !== originalDeliveryDate;
    // Only require reason if the demand was ALREADY delivered and the date is being changed
    const isAlreadyDelivered = demand?.status === 'ENTREGUE';
    const showReasonField = isGestor && isAlreadyDelivered && deliveryDateChanged;

    const [showSupport, setShowSupport] = useState(!!demand?.support_analyst_id);
    const [openClient, setOpenClient] = useState(false);

    const handleSubmit = (e) => {
        e.preventDefault();

        // Validate delivery_date change reason
        if (showReasonField && !formData.delivery_date_change_reason.trim()) {
            alert('Por favor, informe o motivo da alteração da data de entrega.');
            return;
        }

        // Sanitize data: convert empty strings to null for ID fields
        const cleanedData = {
            ...formData,
            client_id: formData.client_id === "" ? null : formData.client_id,
            analyst_id: formData.analyst_id === "" ? null : formData.analyst_id,
            cycle_id: formData.cycle_id === "" ? null : formData.cycle_id,
            requester_id: formData.requester_id === "" ? null : formData.requester_id,
            support_analyst_id: formData.support_analyst_id === "" ? null : formData.support_analyst_id,
        };

        onSave(cleanedData);
    };

    const DatePicker = ({ value, onChange, label, disabled }) => (
        <div className="space-y-2">
            <Label className="text-sm text-slate-600">{label}</Label>
            <Popover>
                <PopoverTrigger asChild>
                    <Button
                        variant="outline"
                        disabled={disabled}
                        className={cn(
                            "w-full justify-start text-left font-normal h-10",
                            !value && "text-slate-400"
                        )}
                    >
                        <CalendarIcon className="mr-2 h-4 w-4" />
                        {value ? format(parseISO(value), "dd/MM/yyyy", { locale: ptBR }) : "Selecionar data"}
                    </Button>
                </PopoverTrigger>
                <PopoverContent className="w-auto p-0" align="start">
                    <Calendar
                        mode="single"
                        selected={value ? parseISO(value) : undefined}
                        onSelect={(date) => onChange(date ? format(date, 'yyyy-MM-dd') : '')}
                        locale={ptBR}
                    />
                </PopoverContent>
            </Popover>
        </div>
    );

    return (
        <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Nº Demanda</Label>
                    <Input
                        value={formData.demand_number}
                        onChange={(e) => setFormData({ ...formData, demand_number: e.target.value })}
                        placeholder="Opcional"
                        className="h-10"
                    />
                </div>

                <div className="space-y-2 lg:col-span-2">
                    <Label className="text-sm text-slate-600">Produto *</Label>
                    <Input
                        value={formData.product}
                        onChange={(e) => setFormData({ ...formData, product: e.target.value })}
                        placeholder="Nome do produto ou descrição da demanda"
                        required
                        className="h-10"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Artefato *</Label>
                    <Select
                        value={formData.artifact}
                        onValueChange={(v) => setFormData({ ...formData, artifact: v })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="Orçamento">Orçamento</SelectItem>
                            <SelectItem value="Proposta">Proposta</SelectItem>
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Peso</Label>
                    <Select
                        value={String(formData.weight)}
                        onValueChange={(v) => setFormData({ ...formData, weight: Number(v) })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            {[0, 1, 2, 3, 4].map(w => (
                                <SelectItem key={w} value={String(w)}>{String(w)}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Complexidade</Label>
                    <Select
                        value={formData.complexity}
                        onValueChange={(v) => setFormData({ ...formData, complexity: v })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="Baixa">Baixa</SelectItem>
                            <SelectItem value="Média">Média</SelectItem>
                            <SelectItem value="Alta">Alta</SelectItem>
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Cliente</Label>
                    <Popover open={openClient} onOpenChange={setOpenClient}>
                        <PopoverTrigger asChild>
                            <Button
                                variant="outline"
                                role="combobox"
                                aria-expanded={openClient}
                                className="w-full justify-between h-10 font-normal px-3"
                            >
                                <span className="truncate">
                                    {formData.client_id
                                        ? clients.find((c) => String(c.id) === String(formData.client_id))?.name || "Cliente não encontrado"
                                        : "Selecionar cliente..."}
                                </span>
                                <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                            </Button>
                        </PopoverTrigger>
                        <PopoverContent className="w-[--radix-popover-trigger-width] p-0" align="start">
                            <Command>
                                <CommandInput placeholder="Buscar cliente..." />
                                <CommandList>
                                    <CommandEmpty>Nenhum cliente encontrado.</CommandEmpty>
                                    <CommandGroup>
                                        <CommandItem
                                            value="none"
                                            onSelect={() => {
                                                setFormData({ ...formData, client_id: "" });
                                                setOpenClient(false);
                                            }}
                                        >
                                            <Check
                                                className={cn(
                                                    "mr-2 h-4 w-4",
                                                    !formData.client_id ? "opacity-100" : "opacity-0"
                                                )}
                                            />
                                            Nenhum
                                        </CommandItem>
                                        {clients.filter(c => c.active !== false).map((client) => (
                                            <CommandItem
                                                key={client.id}
                                                value={client.name}
                                                onSelect={(currentValue) => {
                                                    // current value comes lowercased from cmdk sometimes, but we used client.name as value
                                                    // safer to use closure client.id
                                                    setFormData({ ...formData, client_id: String(client.id) });
                                                    setOpenClient(false);
                                                }}
                                            >
                                                <Check
                                                    className={cn(
                                                        "mr-2 h-4 w-4",
                                                        String(formData.client_id) === String(client.id) ? "opacity-100" : "opacity-0"
                                                    )}
                                                />
                                                {client.name}
                                            </CommandItem>
                                        ))}
                                    </CommandGroup>
                                </CommandList>
                            </Command>
                        </PopoverContent>
                    </Popover>
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Ciclo</Label>
                    <Select
                        value={formData.cycle_id ? String(formData.cycle_id) : "none"}
                        onValueChange={(v) => setFormData({ ...formData, cycle_id: v === "none" ? "" : v })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue placeholder="Selecionar" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="none">Nenhum</SelectItem>
                            {cycles.filter(c => c.active !== false).map(c => (
                                <SelectItem key={c.id} value={String(c.id)}>{c.name}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Responsável</Label>
                    <Select
                        value={formData.analyst_id ? String(formData.analyst_id) : "none"}
                        onValueChange={(v) => setFormData({ ...formData, analyst_id: v === "none" ? "" : v })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue placeholder="Selecionar" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="none">Não designado</SelectItem>
                            {analysts.filter(a => a.active !== false).map(a => (
                                <SelectItem key={a.id} value={String(a.id)}>{a.name}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2 flex flex-col justify-end pb-2">
                    <div className="flex items-center gap-2 mb-2">
                        <Switch
                            id="has-support"
                            checked={showSupport}
                            onCheckedChange={(checked) => {
                                setShowSupport(checked);
                                if (!checked) {
                                    setFormData(prev => ({ ...prev, support_analyst_id: '' }));
                                }
                            }}
                        />
                        <Label htmlFor="has-support" className="text-sm text-slate-600 cursor-pointer">
                            Recebe Suporte?
                        </Label>
                    </div>

                    {showSupport && (
                        <Select
                            value={formData.support_analyst_id ? String(formData.support_analyst_id) : "none"}
                            onValueChange={(v) => setFormData({ ...formData, support_analyst_id: v === "none" ? "" : v })}
                        >
                            <SelectTrigger className="h-10">
                                <SelectValue placeholder="Responsável Suporte" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="none">Selecione...</SelectItem>
                                {analysts.filter(a => a.active !== false && String(a.id) !== String(formData.analyst_id)).map(a => (
                                    <SelectItem key={a.id} value={String(a.id)}>{a.name}</SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                    )}
                </div>

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Solicitante</Label>
                    <Select
                        value={formData.requester_id ? String(formData.requester_id) : "none"}
                        onValueChange={(v) => setFormData({ ...formData, requester_id: v === "none" ? "" : v })}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue placeholder="Selecionar" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="none">Nenhum</SelectItem>
                            {requesters.filter(r => r.active !== false).map(r => (
                                <SelectItem key={r.id} value={String(r.id)}>{r.name}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                <DatePicker
                    label="Data de Qualificação"
                    value={formData.qualification_date}
                    onChange={(v) => setFormData({ ...formData, qualification_date: v })}
                    disabled={!isGestor && !isNew}
                />

                <DatePicker
                    label="Previsão de Entrega"
                    value={formData.expected_delivery_date}
                    onChange={(v) => setFormData({ ...formData, expected_delivery_date: v })}
                />

                {isGestor && (
                    <DatePicker
                        label="Data de Entrega"
                        value={formData.delivery_date}
                        onChange={(v) => setFormData({ ...formData, delivery_date: v })}
                    />
                )}

                {showReasonField && (
                    <div className="space-y-2 lg:col-span-2">
                        <Label className="text-sm text-red-600">Motivo da Alteração da Data de Entrega *</Label>
                        <Input
                            value={formData.delivery_date_change_reason}
                            onChange={(e) => setFormData({ ...formData, delivery_date_change_reason: e.target.value })}
                            placeholder="Informe o motivo da alteração..."
                            className="h-10 border-red-300 focus:border-red-500"
                            required
                        />
                    </div>
                )}

                <div className="space-y-2">
                    <Label className="text-sm text-slate-600">Status</Label>
                    <Select
                        value={formData.status}
                        onValueChange={(v) => {
                            const updates = { status: v };
                            // Auto-set delivery_date when status changes to ENTREGUE
                            if (v === 'ENTREGUE' && !formData.delivery_date) {
                                updates.delivery_date = format(new Date(), 'yyyy-MM-dd');
                            }
                            setFormData({ ...formData, ...updates });
                        }}
                    >
                        <SelectTrigger className="h-10">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            {STATUS_LIST.map(s => (
                                <SelectItem key={s} value={s}>{s}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>
            </div>

            <div className="space-y-2">
                <Label className="text-sm text-slate-600">Observações</Label>
                <Textarea
                    value={formData.observation}
                    onChange={(e) => setFormData({ ...formData, observation: e.target.value })}
                    placeholder="Detalhes adicionais sobre a demanda..."
                    rows={4}
                    className="resize-none"
                />
            </div>

            <div className="flex items-center justify-end gap-3 pt-4 border-t">
                <Button type="button" variant="outline" onClick={onCancel} disabled={isLoading}>
                    <X className="w-4 h-4 mr-2" />
                    Cancelar
                </Button>
                <Button type="submit" disabled={isLoading} className="bg-indigo-600 hover:bg-indigo-700">
                    <Save className="w-4 h-4 mr-2" />
                    {isLoading ? 'Salvando...' : 'Salvar'}
                </Button>
            </div>
        </form>
    );
}
